/*!
 * modernizr v3.0.0
 * Build http://modernizr.com/download?-adownload-touchevents-dontmin
 *
 * Copyright (c)
 *  Faruk Ates
 *  Paul Irish
 *  Alex Sexton
 *  Ryan Seddon
 *  Alexander Farkas
 *  Patrick Kettner
 *  Stu Cox
 *  Richard Herrera

 * MIT License
 */
;(function(window,document,undefined){var classes=[];function is(obj,type){return typeof obj===type;};var tests=[];var ModernizrProto={_version:'3.0.0',_config:{'classPrefix':'','enableClasses':true,'enableJSClass':true,'usePrefixes':true},_q:[],on:function(test,cb){var self=this;setTimeout(function(){cb(self[test]);},0);},addTest:function(name,fn,options){tests.push({name:name,fn:fn,options:options});},addAsyncTest:function(fn){tests.push({name:null,fn:fn});}};var Modernizr=function(){};Modernizr.prototype=ModernizrProto;Modernizr=new Modernizr();function testRunner(){var featureNames;var feature;var aliasIdx;var result;var nameIdx;var featureName;var featureNameSplit;for(var featureIdx in tests){featureNames=[];feature=tests[featureIdx];if(feature.name){featureNames.push(feature.name.toLowerCase());if(feature.options&&feature.options.aliases&&feature.options.aliases.length){for(aliasIdx=0;aliasIdx<feature.options.aliases.length;aliasIdx++){featureNames.push(feature.options.aliases[aliasIdx].toLowerCase());}}}
result=is(feature.fn,'function')?feature.fn():feature.fn;for(nameIdx=0;nameIdx<featureNames.length;nameIdx++){featureName=featureNames[nameIdx];featureNameSplit=featureName.split('.');if(featureNameSplit.length===1){Modernizr[featureNameSplit[0]]=result;}else{if(Modernizr[featureNameSplit[0]]&&!(Modernizr[featureNameSplit[0]]instanceof Boolean)){Modernizr[featureNameSplit[0]]=new Boolean(Modernizr[featureNameSplit[0]]);}
Modernizr[featureNameSplit[0]][featureNameSplit[1]]=result;}
classes.push((result?'':'no-')+featureNameSplit.join('-'));}}};var docElement=document.documentElement;var isSVG=docElement.nodeName.toLowerCase()==='svg';function setClasses(classes){var className=docElement.className;var classPrefix=Modernizr._config.classPrefix||'';if(isSVG){className=className.baseVal;}
if(Modernizr._config.enableJSClass){var reJS=new RegExp('(^|\\s)'+classPrefix+'no-js(\\s|$)');className=className.replace(reJS,'$1'+classPrefix+'js$2');}
if(Modernizr._config.enableClasses){className+=' '+classPrefix+classes.join(' '+classPrefix);isSVG?docElement.className.baseVal=className:docElement.className=className;}};var prefixes=(ModernizrProto._config.usePrefixes?' -webkit- -moz- -o- -ms- '.split(' '):[]);ModernizrProto._prefixes=prefixes;function createElement(){if(typeof document.createElement!=='function'){return document.createElement(arguments[0]);}else if(isSVG){return document.createElementNS.call(document,'http://www.w3.org/2000/svg',arguments[0]);}else{return document.createElement.apply(document,arguments);}};
/*!
   {
   "name": "a[download] Attribute",
   "property": "adownload",
   "caniuse" : "download",
   "tags": ["media", "attribute"],
   "builderAliases": ["a_download"],
   "notes": [{
   "name": "WhatWG Reference",
   "href": "http://developers.whatwg.org/links.html#downloading-resources"
   }]
   }
   !*/
Modernizr.addTest('adownload',!window.externalHost&&'download'in createElement('a'));function getBody(){var body=document.body;if(!body){body=createElement(isSVG?'svg':'body');body.fake=true;}
return body;};function injectElementWithStyles(rule,callback,nodes,testnames){var mod='modernizr';var style;var ret;var node;var docOverflow;var div=createElement('div');var body=getBody();if(parseInt(nodes,10)){while(nodes--){node=createElement('div');node.id=testnames?testnames[nodes]:mod+(nodes+1);div.appendChild(node);}}
style=createElement('style');style.type='text/css';style.id='s'+mod;(!body.fake?div:body).appendChild(style);body.appendChild(div);if(style.styleSheet){style.styleSheet.cssText=rule;}else{style.appendChild(document.createTextNode(rule));}
div.id=mod;if(body.fake){body.style.background='';body.style.overflow='hidden';docOverflow=docElement.style.overflow;docElement.style.overflow='hidden';docElement.appendChild(body);}
ret=callback(div,rule);if(body.fake){body.parentNode.removeChild(body);docElement.style.overflow=docOverflow;docElement.offsetHeight;}else{div.parentNode.removeChild(div);}
return!!ret;};var testStyles=ModernizrProto.testStyles=injectElementWithStyles;
/*!
   {
   "name": "Touch Events",
   "property": "touchevents",
   "caniuse" : "touch",
   "tags": ["media", "attribute"],
   "notes": [{
   "name": "Touch Events spec",
   "href": "http://www.w3.org/TR/2013/WD-touch-events-20130124/"
   }],
   "warnings": [
   "Indicates if the browser supports the Touch Events spec, and does not necessarily reflect a touchscreen device"
   ],
   "knownBugs": [
   "False-positive on some configurations of Nokia N900",
   "False-positive on some BlackBerry 6.0 builds â€“ https://github.com/Modernizr/Modernizr/issues/372#issuecomment-3112695"
   ]
   }
   !*/
Modernizr.addTest('touchevents',function(){var bool;if(('ontouchstart'in window)||window.DocumentTouch&&document instanceof DocumentTouch){bool=true;}else{var query=['@media (',prefixes.join('touch-enabled),('),'heartz',')','{#modernizr{top:9px;position:absolute}}'].join('');testStyles(query,function(node){bool=node.offsetTop===9;});}
return bool;});testRunner();setClasses(classes);delete ModernizrProto.addTest;delete ModernizrProto.addAsyncTest;for(var i=0;i<Modernizr._q.length;i++){Modernizr._q[i]();}
window.Modernizr=Modernizr;;})(window,document);
var restArgs=function(func,startIndex){startIndex=startIndex==null?func.length-1:+startIndex;return function(){var length=Math.max(arguments.length-startIndex,0);var rest=Array(length);for(var index=0;index<length;index++){rest[index]=arguments[index+startIndex];}
switch(startIndex){case 0:return func.call(this,rest);case 1:return func.call(this,arguments[0],rest);case 2:return func.call(this,arguments[0],arguments[1],rest);}
var args=Array(startIndex+1);for(index=0;index<startIndex;index++){args[index]=arguments[index];}
args[startIndex]=rest;return func.apply(this,args);};};if(typeof PMW==='undefined'){window.PMW={};}
PMW.mergePMW=function(target,source){for(var key in source){if(source.hasOwnProperty(key)&&typeof target[key]==='undefined'){target[key]=source[key];}}};PMW.mergePMW(PMW,{VERSION:1,SERVER_ROOT:'',BASE_URL:'',FB_APP_ID:'',GOOGLE_APP_ID:'',IS_PREMIUM_ENABLED:false,FB_PERMISSIONS:'email',POSTERBUILDER_LOGGING:false,enableGATracking:true,POSTERBUILDER:'PosterBuilder',sharingAfterAction:'',click:'vclick',modals:[],queuedOpenModal:null,util:{animationEndEvents:(function(){var t,el=document.createElement("fakeelement");var animations={"animation":"animationend","OAnimation":"oAnimationEnd","MozAnimation":"animationend","WebkitAnimation":"webkitAnimationEnd"};for(t in animations){if(el.style[t]!==undefined){return animations[t];}}})(),transitionEndEvents:(function(){var t,el=document.createElement("fakeelement");var transitions={"transition":"transitionend","OTransition":"oTransitionEnd","MozTransition":"transitionend","WebkitTransition":"webkitTransitionEnd"};for(t in transitions){if(el.style[t]!==undefined){return transitions[t];}}})(),require:function(test,jsURL,cssURL,cb){if(test){if(typeof cssURL==='string'&&cssURL.length>0){PMW.getScriptAndCSS(jsURL,cssURL,cb);}
else{PMW.getScript(jsURL,cb);}}
else{cb();}},site_url:function(u){return PMW.SERVER_ROOT+u;},addQueryStringParam:function(url,key,value){return url+((url.indexOf('?')!=-1)?'&':'?')+encodeURIComponent(key)+'='+encodeURIComponent(value);},getQueryStringValue:function(key){return decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]"+encodeURIComponent(key).replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"));},getQueryStringValues:function(){var vars={},hash,hashIndex=window.location.href.indexOf('#'),hashes;if(hashIndex>0){hashes=window.location.href.slice(window.location.href.indexOf('?')+1,hashIndex).split('&')}else{hashes=window.location.href.slice(window.location.href.indexOf('?')+1).split('&');}
for(var i=0;i<hashes.length;i++){hash=hashes[i].split('=');if(hash.length==2){vars[hash[0]]=hash[1];}}
return vars;},isValidEmail:function(v){return /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(v);},setCookie:function(name,value,days){var expires,date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString();document.cookie=name+"="+value+expires+"; path=/";},readCookie:function(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)===' ')
c=c.substring(1,c.length);if(c.indexOf(nameEQ)===0)
return c.substring(nameEQ.length,c.length);}
return null;},deleteCookie:function(name){document.cookie=encodeURIComponent(name)+"=deleted; expires="+new Date(0).toUTCString();},doPost:function(uri,params){var xmlHTTP=new XMLHttpRequest();xmlHTTP.open("POST",PMW.util.site_url(uri),true);xmlHTTP.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlHTTP.send(params);},escapeHTML:function(unsafeStr){return unsafeStr.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/\'/g,'&#39;').replace(/\//g,'&#x2F;')}},google:{loadApi:function(cb){$.getScript("https://apis.google.com/js/platform.js",onScriptLoaded);var auth2=null;function onScriptLoaded(){if(gapi){gapi.load('auth2',onAuthLoad);}}
function onAuthLoad(){auth2=gapi.auth2.init({client_id:PMW.GOOGLE_APP_ID,scope:'profile email openid'});auth2.then(onAuthInitiated,PMW.google.onError);}
function onAuthInitiated(){var loginButton_=$('.btn-google-login');loginButton_.prop('disabled',false);PMW.onClick(loginButton_,null,onGoogleLogin);}
function onGoogleLogin(){PMW.google.login(cb,auth2);}},login:function(url,auth2){auth2.signIn().then(onSignIn);function onSignIn(){PMW.google.connect(auth2.currentUser.get().getAuthResponse().id_token,url);}},onError:function(){alert('Sorry, there was an error while logging you in via Google. Please delete cookies from your web browser and try again.');PMW.trackGAEvent('User','GoogleConnectError',window.location.href,null);},connect:function(identityToken,url,email){email=typeof email!=='undefined'?email:'';$.get(PMW.util.site_url('authenticate/googleSignIn/'+new Date().getTime().toString()),{identityToken:identityToken,email:email},function(r){if(r.status==='success'){if(typeof r.data.needemail!=='undefined'&&r.data.needemail===1){PMW.showEmailRequiredDialog(PMW.google.connect.bind(this,identityToken,url));}else if(typeof r.data.emailExists!=='undefined'){PMW.showAlternativeEmailRequiredDialog(r.data.emailExists,PMW.google.connect.bind(this,identityToken,url));}else{if(r.isnew==1){$.post(PMW.util.site_url('user/updateProfilePictureFromGoogle'),{imageURL:r.pictureURL},null);PMW.openEmailOptInModal(r.data.action,url);}
else{PMW.onConnectSuccess(r.data.action,url);}}}else if(r.status==='fail'&&typeof r.data.invalidemail!=='undefined'&&r.data.invalidemail===1){PMW.showEmailRequiredDialog(PMW.google.connect.bind(this,identityToken,url));PMW.showEmailDialogMessage($('#invalidemail'));$('#emailsignup').focus();}else{PMW.google.onError();}},'json');}},fb:{login:function(cb,perms){if(typeof FB==='undefined'){alert('Sorry, unable to communicate with Facebook. Please wait for the page to load complete then try again.');return;}
if(PMW.isStudent()){alert('Sorry, Facebook features are not available to students.');return;}
if(perms===undefined){perms=null;}
FB.login(cb,perms);},connect:function(url,accessToken,email){email=typeof email!=='undefined'?email:'';accessToken=typeof accessToken!=='undefined'?accessToken:'';$.get(PMW.util.site_url('authenticate/facebookconnect/'+new Date().getTime().toString()),{email:email,accessToken:accessToken},function(r){if(typeof r.data.accessToken!=='undefined'){accessToken=r.data.accessToken;}
if(r.status==='success'){if(r.data.redirect!==''){window.location.href=r.data.redirect;return;}
if(typeof r.data.needemail!=='undefined'&&r.data.needemail===1){PMW.showEmailRequiredDialog(PMW.fb.connect.bind(this,url,accessToken));}else if(typeof r.data.emailExists!=='undefined'){PMW.showAlternativeEmailRequiredDialog(r.data.emailExists,PMW.fb.connect.bind(this,url,accessToken));}else{if(r.data.isnew==1){PMW.openEmailOptInModal(r.data.action,url);}
else{PMW.onConnectSuccess(r.data.action,url);}}}else if(r.status==='fail'&&typeof r.data.invalidemail!=='undefined'&&r.data.invalidemail===1){PMW.showEmailRequiredDialog(PMW.fb.connect.bind(this,url,accessToken));PMW.showEmailDialogMessage($('#invalidemail'));$('#emailsignup').focus();}else{alert('Sorry, there was an error while logging you in via Facebook. Please delete cookies from your web browser and try again.');PMW.trackGAEvent('User','FBConnectError',window.location.href,null);}},'json');},getLoginStatus:function(onConnected,onOther){FB.getLoginStatus(function(r){if(r.status==='connected'){onConnected(r.authResponse);}
else{onOther(r.authResponse);}});},hasPermission:function(permission,allowedCallback,deniedCallback,preAskPermCallback,onClickElement){PMW.fb.getLoginStatus(function(authResponse){$.post(PMW.util.site_url('authenticate/haspermission'),{perm:permission,token:authResponse.accessToken},function(data){if(data==='yes'){allowedCallback(authResponse);}
else{if($.isFunction(preAskPermCallback)){preAskPermCallback();if(onClickElement){onClickElement.unbind('click').click(function(){fbloginpermloop();});}}
else{fbloginpermloop();}}});},fbloginpermloop);function fbloginpermloop(){PMW.fb.login(function(response){if(response.authResponse){$.post(PMW.util.site_url('authenticate/haspermission'),{perm:permission,token:response.authResponse.accessToken},function(data){if(data=='yes'){allowedCallback();}
else{deniedCallback();}});}else{deniedCallback();}},{scope:permission});}}},init:function(){window.onerror=PMW.onWindowError;},onWindowError:function(msg,url,line,col,error){if(typeof url==='string'&&url.length>0&&url.indexOf(PMW.BASE_URL)>0){var extra=!col?'':'\ncolumn: '+col;extra+=!error?'':'\nerror: '+error;var log="Error: "+msg+"\nurl: "+url+"\nline: "+line+extra;PMW.log(log);}
return false;},openEmailOptInModal:function(action,url){var dlg=PMW.openModalDialog('emailoptin-modal','Deals & Promotions',{'Complete Signup':function(){if($('#emailoptinchk').is(':checked')){$.post(PMW.util.site_url('authenticate/subscribetoemails'),null,function(){PMW.closeModalDialog('emailoptin-modal');});}
else{PMW.closeModalDialog('emailoptin-modal');}}},false,'-modal-400',true);dlg.find('.close').hide();dlg.on('modal:close',PMW.onConnectSuccess.bind(this,action,url));dlg.find('.content').html('<p><input type="checkbox" id="emailoptinchk"/><label for="emailoptinchk">Notify me of freebies and discounts.</label></p>');$('#emailoptinchk').prop('checked',true);},onConnectSuccess:function(action,url){if(action==='refresh'){window.location.reload();}
else if(action>0){if(typeof url==='string'&&url!=''){window.location.href=url;}
else if($.isFunction(url)){url(action);}
else{window.location.reload();}}},onClick:function(el,s,h,d){if(typeof $==='undefined'||typeof $.vmouse=='undefined'){PMW.click='click';}
if(!isNaN(d)){el.data('dblTimer',-1);el.on(PMW.click,s,function(e){e.preventDefault();if(!$(e.currentTarget).hasClass('disabled')&&el.data('dblTimer')===-1){el.data('dblTimer',setTimeout(function(){el.data('dblTimer',-1);},d));h.apply(this,[e]);}});}else{el.on(PMW.click,s,function(e){e.preventDefault();var el=$(e.currentTarget);if(!el.hasClass('disabled')&&el.prop('disabled')!=true){h.apply(this,[e]);}});}
return el;},initHeader:function(){function c(id){var e=document.getElementById(id);e.className='';return e;}
function i(id,h){var e=document.getElementById(id);if(e){e.innerHTML=h;}}
function del(id){var e=document.getElementById(id);if(e){e.parentNode.removeChild(e);}}
var pmwn=PMW.util.readCookie('pmwn'),n=document.getElementById('nav');if(n){if(pmwn!==null&&pmwn!=='new+user'){pmwn=decodeURIComponent(pmwn.replace(/\+/g,' '));del('navauth');del('nav-auth-small');document.getElementById('navuser').setAttribute('title',pmwn);i('ulname',pmwn);i('ulname-toggled',pmwn);if(n){n.className+=' -loggedin';}}
var la=PMW.util.readCookie('pmwla');if(la){if(n){n.className+=' su';}}}},getUserType:function(){var c=PMW.util.readCookie('pmwi');if(typeof c==='string'){var p=c.split('.');if(p.length>1){return p[1];}}
return'notloggedin';},getUserPremiumLevel:function(){var c=PMW.util.readCookie('pmwp');if(typeof c==='string'){return parseInt(c);}
return 0;},getUserId:function(){var c=PMW.util.readCookie('pmwi');if(typeof c==='string'){var p=c.split('.');if(p.length>1){return parseInt(p[0]);}}
return'notloggedin';},isEDU:function(){var userType=this.getUserType();return(userType==='teacher'||userType=='student');},isTeacher:function(){return this.getUserType()==='teacher';},isStudent:function(){return this.getUserType()==='student';},hideForEDU:function(ctx){if(PMW.isEDU()){if(!ctx){ctx=document;}
$('.eduhide',ctx).hide();}},toggleForDesigner:function(ctx){if(PMW.getUserType()==='designer'){if(!ctx){ctx=document;}
$('.designer-toggle:visible').remove();$('.designer-toggle',ctx).removeClass('hidden').show();}},hideForStudent:function(ctx){if(PMW.isStudent()){if(!ctx){ctx=document;}
var a=$(ctx).find('a.student-redirect');$.each(a,function(){$(this).attr('href',PMW.util.site_url('edu/denied'));});$('.student-hide',ctx).removeClass('visible-desktop').hide();return true;}
return false;},toggleInOut:function(el,show){if(show&&el.hasClass('out')){el.removeClass('out').addClass('in');}
else if(!show&&el.hasClass('in')){el.removeClass('in').addClass('out');}
return el;},changeSearchForStudent:function(ctx){if(!ctx){ctx=$('#nav form');}
ctx.attr('action',PMW.util.site_url('posters/ssearch'));},isPosterMaker:function(){return(typeof PMConfig!=='undefined');},logout:function(serverLogoutURL){if(typeof FB!=='undefined'&&FB.getAuthResponse()){FB.logout(function(){if(serverLogoutURL){window.location.href=serverLogoutURL;}});}
else if(serverLogoutURL){window.location.href=serverLogoutURL;}},log:function(t){PMW.util.doPost('error/clientlog','message='+encodeURIComponent(t));},pblog:function(m){if(PMW.POSTERBUILDER_LOGGING){$.post(PMW.util.site_url('posterbuilder/log'),{m:m});}},trackGAEvent:function(category,action,label,value){if(!PMW.enableGATracking){return;}
try{if(value==null||value<0){ga('send','event',category,action,label,null);}
else{ga('send','event',category,action,label,value);}}
catch(e){}},incrementPosterView:function(id,idcreator,ignoredIds){if(id!==null){$.post(PMW.util.site_url('poster/viewed'),{'id':id,'idcreator':idcreator,'ignored[]':ignoredIds});}},showEmailDialogMessage:function(messageNode){var emailSignupModal=$('#emailsignup-modal');if(!emailSignupModal.hasClass('-with-message')){emailSignupModal.addClass('-with-message');messageNode.show(250);}else{messageNode.show(250);messageNode.addClass('animated flash').one(PMW.util.animationEndEvents,function(){messageNode.removeClass('animated flash');});}},showEmailRequiredDialog:function(cb){var txtEmailSignup,passwordField,errorEmptyPass,errorIncorrectPass,errorResponse,errorExistingEmail,modalContent,errorInvalidEmail,modalCloseBtn,esDlg=PMW.openModalDialog('emailsignup-modal','Email Required',{'Continue':function(){txtEmailSignup=$('#emailsignup');passwordField=$('.password-field');errorEmptyPass=$('.error-empty-password');errorIncorrectPass=$('.error-wrong-password');errorResponse=$('.error-response');errorExistingEmail=$('.error-existing-email');errorInvalidEmail=$('#invalidemail');modalContent=esDlg.find('.modal-content');modalCloseBtn=esDlg.find('.modal-btn-close');function hideErrors(){errorIncorrectPass.hide();errorResponse.hide();errorEmptyPass.hide();errorExistingEmail.hide();}
hideErrors();var email=$.trim(txtEmailSignup.val()),passwordTextField=$('#verify-password'),password=$.trim(passwordTextField.val());txtEmailSignup.on('keyup',function(){passwordField.hide();hideErrors();modalContent.removeClass('add-password-row');});modalCloseBtn.off();if(PMW.isPosterMaker()){PMW.onClick(modalCloseBtn,null,function(){openExitConfirmationDialog();})}
function openExitConfirmationDialog(){var confirmDialog=PMW.openModalDialog('emailsignup-confirmation-modal','Cancel Login Using Facebook',{'Cancel':function(){PMW.closeModalDialog('emailsignup-confirmation-modal');},'Close':function(){PMW.closeModalDialog('emailsignup-confirmation-modal');PMW.closeModalDialog('emailsignup-modal');}},false,'-modal-250 -flex',false);confirmDialog.find('.content').html('<h5>Are you sure you want to cancel logging in using Facebook?</h5>');confirmDialog.find('.close').hide();}
if(email.length>0){if(passwordField.is(':hidden')){$.post(PMW.util.site_url('authenticate/verifyUserEmailState'),{'email':email},function(r){if(r.status==='success'){$('#invalidemail').hide();switch(r.data.state){case'allow':cb(email);PMW.closeModalDialog('emailsignup-modal');hideErrors();break;case'ask-password':passwordField.show();modalContent.addClass('add-password-row');break;case'redirect':if(PMW.isPosterMaker()){PMW.showEmailDialogMessage(errorExistingEmail);modalCloseBtn.show();}else{PMW.closeModalDialog('emailsignup-modal');modalContent.removeClass('add-password-row');window.location.href=PMW.util.site_url('authenticate/showlogin');}
return;break;case'invalid':PMW.showEmailDialogMessage(errorInvalidEmail);passwordTextField.focus();break;}}else{PMW.showEmailDialogMessage(errorResponse);txtEmailSignup.focus();}});}else{if(password.length>0){$.post(PMW.util.site_url('authenticate/verifyUserEmailAndPassword'),{'email':email,'password':password},function(r){if(r.status==='success'){if(r.data.match){PMW.closeModalDialog('emailsignup-modal');cb(email);}else{PMW.showEmailDialogMessage(errorIncorrectPass);passwordTextField.focus();}}else{PMW.showEmailDialogMessage(errorResponse);txtEmailSignup.focus();}});}else{PMW.showEmailDialogMessage(errorEmptyPass);passwordTextField.focus();}}}
else{PMW.showEmailDialogMessage(errorInvalidEmail);txtEmailSignup.focus();}}},false,'-modal-500 -flex',false);esDlg.find('.close').hide();esDlg.find('.content').html('<div class="field"><label for="emailsignup">Please enter your email address to login</label><input type="email" class="text input" id="emailsignup" placeholder="Enter your email address" autocapitalize="off" autocorrect="off" autocomplete="email"/><span class="fineprint">Don\'t worry, we hate spam as much as you do.</span></div>'+'<div id="invalidemail" class="danger alert hidden">Please enter a valid email address.</div>'+'<div class="field password-field hidden"><label for="verify-password">An account with this email already exists. Please enter its password to login and connect with Facebook.</label>'+'<input type="password" class="text input" id="verify-password" placeholder="Enter your password" autocapitalize="off" autocorrect="off" /></div>'+'<div class="error-empty-password danger alert hidden">Please enter a password.</div>'+'<div class="error-wrong-password danger alert hidden">Incorrect password.</div>'+'<div class="error-response danger alert hidden">Sorry, there was error. Please try again.</div>'+'<div class="error-existing-email danger alert hidden">Sorry, a Facebook account is already associated with this email. Use a different email address.</div>');},showAlternativeEmailRequiredDialog:function(email,cb){var txtEmail,aerDialog=PMW.openModalDialog('alternative-email-modal','Alternative Email Required',{'Cancel':function(){PMW.closeModalDialog('alternative-email-modal');},'Continue':function(){txtEmail=aerDialog.find('.email');var email=$.trim(txtEmail.val());if(email.length>0){PMW.closeModalDialog('alternative-email-modal');cb(email);}
else{PMW.showEmailDialogMessage($('#invalidemail'));txtEmail.focus();}}},false,'-modal-550 -flex');aerDialog.find('.content').html('<p>A PosterMyWall account with the email address &#39;'+PMW.util.escapeHTML(email)+'&#39; already exists. Please provide an alternative email address.</p><div class="field"><input type="email" class="text input email" placeholder="Enter your email address" autocapitalize="off" autocorrect="off" autocomplete="email"/></div><p><a href="javascript:void(0)" class="existing-account-info">Click here for more information.</a></p><div id="invalidemail" class="danger alert hidden">Please enter a valid email address.</div>');PMW.onClick(aerDialog.find('.existing-account-info'),null,PMW.showExistingAccountDialog.bind(this,email));},showExistingAccountDialog:function(email){var eaDialog=PMW.openModalDialog('existing-account-modal','Account Already Exists',{'OK':function(){PMW.closeModalDialog('existing-account-modal');}},false,'-modal-550 -modal-h-450 -flex');eaDialog.find('.content').html('<p>A PosterMyWall account with the email address &#39;'+PMW.util.escapeHTML(email)+'&#39; already exists. You need to provide an alternative email address.</p><p>If you have forgotten the password to the &#39;'+PMW.util.escapeHTML(email)+'&#39; account, please log out and click the "Forgot your password?" link on the log in page.</p><p>To access designs from one account to another, please use the Share option.</p><p>If you would like to transfer your designs over to one account, please <a href="'+PMW.util.site_url('info/contactus')+'">contact support<a/>.</p>');},premiumContentBlockMessage:function(){var idModal='premium-cannot-purchase-modal';PMW.openModalDialog(idModal,'Cannot purchase premium content',{'Close':function(){PMW.closeModalDialog(idModal);}},false,PMW.isPosterMaker()?'-flex':'').find('.content').html('<p>Getty Images requires all purchases to be composite images, not a plain stock image. Please add items to your design in order to checkout.</p>');},openPublishDialog:function(idPoster,idUser){PMW.util.require((typeof PMW.publishDialog_openEvent==='undefined'),'components/invite-contributors.js,components/publish-dialog.js','views/modal/publish-dialog.css',PMW.doOpenPublishDialog.bind(PMW,idPoster,idUser));},doOpenPublishDialog:function(idPoster,idUser){var t='Share Design',publishDialog=PMW.openModalDialog('poster-share-modal',t,{},true,'share-modal');if(PMW.isPosterMaker()){publishDialog.addClass('from-builder -flex');}
var params={idPoster:idPoster,idUser:idUser,basetitle:t};publishDialog.data(params).find('.content').load(PMW.util.site_url('poster/publishdialog'),{idposter:publishDialog.data('idPoster'),isPosterMaker:PMW.isPosterMaker()},function(){if($('#publishDialogError').length===0){PMW.publishDialog_openEvent(publishDialog);}});},showPremiumOnlyFeatureDialog:function(){var btnText=PMW.isPosterMaker()?'Learn More':'About PosterMyWall Premium',buttons={};buttons[btnText]=function(){window.location.href=PMW.util.site_url('info/premium')};var dialog=PMW.openModalDialog('premium-only-dialog','Premium Only Feature',buttons,false,PMW.isPosterMaker()?'-flex':''),content=dialog.find('.content');content.load(PMW.util.site_url('premium/premiumOnlyDialog'));},addVersion:function(url){return url.indexOf('?')==-1?url+'?_='+PMW.VERSION:url+'&_='+PMW.VERSION},getScript:function(url,cb){if(typeof url==='string'&&url.indexOf('http')!==0){url=this.addVersion(PMW.util.site_url('asset/getjs?files='+url));}
return $.ajax({dataType:"script",cache:true,url:url}).done(cb).fail(function(){alert('Sorry, there was a problem. Please check your Internet connection and reload this page');});},getScriptAndCSS:function(jsPath,cssPath,cb){$.when($.ajax({dataType:'script',cache:true,url:this.addVersion(PMW.util.site_url('asset/getjs?files='+jsPath))}),$.ajax({cache:true,url:this.addVersion(PMW.util.site_url('asset/getcss?files='+cssPath))})).then(function(data,css){$('<style>'+css+'</style>').appendTo('head');if($.isFunction(cb)){cb();}}).fail(function(){alert('Sorry, there was a problem. Please check your Internet connection and reload this page');});},openModalDialog:function(idModal,title,buttons,destroyOnClose,modalClass,experimental){if(typeof destroyOnClose==='undefined'){destroyOnClose=false;}
var html=$('html'),body=$('body');body.addClass('-open-modal');if(typeof experimental==='undefined'||html.hasClass('oldie')||html.hasClass('ie9')){experimental=false;}
if(typeof modalClass==='undefined'){modalClass='';}
var modal,mc;if(typeof PMW.modals[idModal]==='undefined'){PMW.modals[idModal]=destroyOnClose?'open-destroy':'open';body.append($('<div class="modal modal-open '+(experimental?'vertical-align-wrap':'')+'" id="'+idModal+'">'+(experimental?'<div class="vertical-align">':'')+'<div class="modal-content"><div class="header"><div class="title""><h2>'+title+'</h2></div><div class="actions"><a href="javascript:void(0)" class="action close modal-btn-close">Close</a></div></div><div class="content"><h2 class="please-wait">Please Wait&hellip;</h2></div></div>'+(experimental?'</div>':'')+'</div>'));modal=$('#'+idModal).addClass(modalClass);mc=modal.find('.modal-content');var content=mc.find('.content');mc.addClass('animated fadeInDown').one(PMW.util.animationEndEvents,function(){mc.removeClass('animated fadeInDown');});if(!$.isEmptyObject(buttons)){var footer=$('<div class="footer vertical-align-wrap"><div class="vertical-align"><div class="primary-actions"></div></div></div>');mc.append(footer);$.each(buttons,function(name,props){var btn=PMW.isPosterMaker()?$('<button class="btn btn-primary">'+name+'</button>'):$('<div class="btn primary medium"><button>'+name+'</button></div>');var click=typeof $.mobile!=='undefined'?PMW.click:'click';if(typeof props=='function'){PMW.onClick(btn,null,props)}else if(typeof props=='object'){if(typeof props.ch=='function'){PMW.onClick(btn,null,props.ch);}
if(typeof props.classes=='string'){btn.addClass(props.classes);}}
modal.find('.footer .primary-actions').append(btn);});}
if(!experimental){PMW.updateModalDimensions(modal);}
modal.find('.close').on('click',this.closeModalDialog.bind(this,idModal));}else if(PMW.modals[idModal]==='closed'){modal=$('#'+idModal);mc=modal.find('.modal-content');PMW.updateModalDimensions(modal);modal.addClass('modal-open');mc.addClass('animated fadeInDown').one(PMW.util.animationEndEvents,function(){mc.removeClass('animated fadeInDown');});}else if(PMW.modals[idModal]==='closing'){modal=$('#'+idModal);PMW.queuedOpenModal=PMW.openModalDialog.bind(this,idModal,title,buttons,destroyOnClose);}else{modal=$('#'+idModal);}
return modal;},closeModalDialog:function(idModal){var modal=$('#'+idModal),mc=modal.find('.modal-content'),destroy=false;if(PMW.modals[idModal]==='open-destroy'){destroy=true;}
PMW.modals[idModal]='closing';mc.addClass('animated fadeOutUp').one(PMW.util.animationEndEvents,function(){modal.removeClass('modal-open');mc.removeClass('animated fadeOutUp');if(destroy){modal.remove();delete PMW.modals[idModal];}else{PMW.modals[idModal]='closed';}
if($.isFunction(PMW.queuedOpenModal)){PMW.queuedOpenModal();PMW.queuedOpenModal=null;}});modal.trigger('modal:close');$('body').removeClass('-open-modal');},updateModalDialogTitle:function(modal,title){modal.find('.title h2').text(title);},addModalHeaderButtons:function(modal,buttons){var p=modal.find('.header .actions');if(p){for(var button in buttons){var span=$('<span>');span.addClass(buttons[button].classes);span.prepend(' | ');var btn=document.createElement('a');btn.setAttribute('href','javascript:void(0)');btn.setAttribute('class','action');btn.innerHTML=button;PMW.onClick($(btn),null,buttons[button].cb).prependTo(span);p.prepend(span);}}},updateModalDimensions:function(m){if(!m.hasClass('-flex')){var mc=m.find('div.modal-content');mc.find('div.content').height(mc.height()-mc.find('div.header').outerHeight(true)-mc.find('div.footer').outerHeight(true));if(m.hasClass('full-screen')){mc.css('margin-top',0);}else{mc.css('margin-top',Math.ceil(($(window).height()-mc.height())/2)+'px');}}},appendFooterToModalDialog:function(modal){if(modal.find('.footer').length===0){var mc=modal.find('.modal-content');var footer=$('<div class="footer vertical-align-wrap"><div class="vertical-align"><div class="primary-actions"></div></div></div>');var content=mc.find('.content');mc.append(footer);content.innerHeight(mc.outerHeight()-modal.find('.header').outerHeight(true)-footer.outerHeight(true)-parseInt(content.css('padding-top').replace("px",""),10)-parseInt(content.css('padding-bottom').replace("px",""),10));}},createModalDialogButtons:function(modal,buttons,replace){PMW.appendFooterToModalDialog(modal);if(typeof replace==='undefined'||replace===true){modal.find('.primary-actions .btn').remove();}
$.each(buttons,function(name,props){var click=typeof $.mobile!=='undefined'?PMW.click:'click',btn;if(PMW.isPosterMaker()){btn=$('<button type="button" class="btn btn-primary">'+name+'</button>');}else{btn=$('<div class="btn primary medium"><button type="button">'+name+'</button></div>');}
btn.on(click,props);modal.find('.footer .primary-actions').append(btn);});},freeEditDialog:function(response){var idOrder=response.idOrder,checkout=response.checkout,modal=PMW.openModalDialog('free-edit','One Time Free Edit',{'Recreate For Free':function(){PMW.trackGAEvent('Cart','FreeOnetimeEditOption','Regen',null);setTimeout(function(){window.location.href=PMW.util.site_url('cart/downloadregen/'+idOrder);},250);},'Place New Order':function(){if(response.url){PMW.postCheckoutProcessing(response);}else{PMW.checkout.showCheckoutDialog(PMW.checkout.MODE_DOWNLOAD,checkout);}
PMW.closeModalDialog('free-edit');PMW.trackGAEvent('Cart','FreeOnetimeEditOption','NewOrder',null);}},false,PMW.isPosterMaker()?'-flex':'');if(modal.find('.content p').length===0){modal.find('.content').html("<p>Is this design an edited version of a download you purchased within the last 24 hours? We allow three edits in case there was a mistake in your order.</p>");}
PMW.trackGAEvent('Cart','FreeOnetimeEdit',null,null);},postCheckoutProcessing:function(response,form){form=typeof form=='undefined'?$('.frm-buy-download'):form;var em='Sorry, there was an error while processing your request. Please try again.';if(PMW&&$.isFunction(PMW.setLoading)){PMW.setLoading(null);form.find('[type="submit"]').prop('disabled','').parent().removeClass('disabled');}
if(response==null){alert(em);}
else{if(response.message){if(response.premium>0){PMW.premiumContentBlockMessage();}
else{form.find('.promo-error').removeClass('_hidden').html(response.message);}}
else if(response.url){window.location.href=response.url;}
else if(response.checkout){PMW.checkout.showCheckoutDialog(PMW.checkout.MODE_DOWNLOAD,response.checkout);}
else{alert(em);}}},loadAddThisToolbox:function(el,cb){cb=cb||null;var u=el.attr('data-url');if(u!=null&&u.length>0){el.load(PMW.util.site_url('addthis/toolbox'),{url:u,title:el.attr('data-title'),count:el.attr('data-count'),compact:el.attr('data-compact'),track:el.attr('data-track'),style:el.attr('data-style'),loadScript:(typeof addthis==='undefined')},function(){window.addthis_config={data_track_addressbar:true};if(typeof addthis==='undefined'){$.getScript("https://s7.addthis.com/js/300/addthis_widget.js#pubid=jafferhaider&async=1",function(){if(typeof addthis!=='undefined'){PMW.initAddThis(el.attr('data-gaCategory'),el.attr('data-gaAction'),cb);}}.bind(this));}else{PMW.initAddThis(el.attr('data-gaCategory'),el.attr('data-gaAction'),cb);}});}},initAddThis:function(cb){if(!PMW.addThisInit){PMW.addThisInit=true;addthis.init();if(PMW.isPosterMaker()){addthis.addEventListener('addthis.menu.share',function(e){PMW.trackGAEvent(PMW.POSTERBUILDER,PMW.sharingAfterAction,e.data.service);});}}
addthis.toolbox(".addthis_toolbox_parent");if($.isFunction(cb)){cb();}},debounce:function(func,wait,immediate){var timeout,result;var later=function(context,args){timeout=null;if(args)result=func.apply(context,args);};var debounced=restArgs(function(args){var callNow=immediate&&!timeout;if(timeout)clearTimeout(timeout);if(callNow){timeout=setTimeout(later,wait);result=func.apply(this,args);}else if(!immediate){timeout=PMW.delay(later,wait,this,args);}
return result;});debounced.clear=function(){clearTimeout(timeout);timeout=null;};return debounced;},delay:restArgs(function(func,wait,args){return setTimeout(function(){return func.apply(null,args);},wait);})});if(Modernizr&&Modernizr.addTest){Modernizr.addTest('edge',function(){return!!navigator.userAgent.match(/edge/i);});}
PMW.init();
PMW.checkout=(function(){var stripeLoader_=null,mode_='',modePrintInit_=false,modeDownloadInit_=false,addressMode_='shipping',idShippingAddress_=-1,idBillingAddress_=-1,idShippingMethod_=-1,facade_=null,STRIPE_PRICE_FLOOR=7.99,ID_MODAL='checkout-modal',MODE_PRINT='print',MODE_DOWNLOAD='download',MODE_SUBSCRIPTION='subscription',MODE_MANAGE_CARDS_PREMIUM='manage-premium',MODE_MANAGE_CARDS='manage',MODE_CHANGE_SUBSCRIPTION_PLAN='change-subscription-plan',MODE_AMAZON_PRINT_CHECKOUT='amazon-print-checkout',MODE_STRIPE_PRINT_CHECKOUT='stripe-print-checkout',FLOW_FORWARD='forward',FLOW_BACKWARD='backward';function show_(id,direction){var p=$('#'+id),modal=$('#'+ID_MODAL),btnPaymentOptions=modal.find('.btn-payment-options');if(!p.hasClass('-active')){var active=p.siblings('.-active');if(typeof direction!='undefined'){if(direction=='forward'){active.addClass('-left');}else{active.removeClass('-left');}}
active.removeClass('-active');p.addClass('-active');}
switch(id){case'checkout-add-card':var form=getCardForm_();if(form.attr('data-stripe-init')==0&&typeof Stripe=='undefined'){stripeLoader_=$.getScript("https://js.stripe.com/v2/").done(function(){form.attr('data-stripe-init',1);Stripe.setPublishableKey(form.attr('data-stripe-key'));}).fail(function(xhr,status){PMW.log('Unable to load StripeJS from https://js.stripe.com/v2. XHR Status: '+status);alert('Sorry, there was an error while setting up payments. Please reload the page and try again.');PMW.checkout.onCheckoutStart_(false);});}
form.find('input').val('');if(mode_==MODE_STRIPE_PRINT_CHECKOUT){var checkoutQuick=$('#checkout-quick');if(checkoutQuick.find('.list-item').length>0){p.find('.btn-back-to-billing').addClass('_hidden');p.find('.btn-back-to-cards').removeClass('_hidden');}else{p.find('.btn-back-to-billing').removeClass('_hidden');p.find('.btn-back-to-cards').addClass('_hidden');}}
break;case'checkout-add-address':if(addressMode_=='shipping'){p.find('.title').text('Enter Shipping Address');p.find('.region-open').addClass('_hidden');p.find('.region-states').removeClass('_hidden');$('#checkout-address-country-code').val('US').prop('disabled',true).parent().addClass('_hidden');$('#checkout-address-country-code-readonly').removeClass('_hidden');p.find('.shipping-info').removeClass('_hidden');}else{p.find('.title').text('Enter Billing Address');p.find('.region-open').removeClass('_hidden');p.find('.region-states').addClass('_hidden');$('#checkout-address-country-code').prop('disabled',false).parent().removeClass('_hidden');$('#checkout-address-country-code-readonly').addClass('_hidden');p.find('.shipping-info').addClass('_hidden');}
p.parent().scrollTop(0);p.find('.input:not(.-no-clear)').val('');modal.removeClass('-print-checkout').addClass('-add-address');removeValidationErrorMessages($('#checkout-add-address').find('.field'));break;case'checkout-select-shipping-address':if(idShippingAddress_==-1){p.find('.btn-continue-checkout').addClass('disabled').prop('disabled',true);}
modal.addClass('-print-checkout');break;case'checkout-quick':if(mode_==MODE_STRIPE_PRINT_CHECKOUT){if(p.find('.payment-card.-selected').length>0){p.find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);}}
break;case'checkout-print-review':modal.addClass('-print-checkout-review');break;}
if(id=='checkout-options'){var btnPayWithCard=p.find('.btn-pay-with-card');if(btnPayWithCard.attr('data-show')=='1'){btnPayWithCard.removeClass('_hidden');}
btnPaymentOptions.addClass('_hidden');}else{btnPaymentOptions.removeClass('_hidden');}}
function setLoading_(text){if(facade_){var key='checkout-dialog';if(text==null){facade_.sendNotification(postermywall.Core.HIDE_LOADING,{key:key})}
else{facade_.sendNotification(postermywall.Core.SHOW_LOADING,{key:key,text:text});}}
else{PMW.setLoading(text);}}
function getCardForm_(form){return typeof form==='undefined'?$('#checkout-add-card-form'):form;}
function getAddressForm_(form){return typeof form==='undefined'?$('#checkout-add-address-form'):form;}
function setFormError_(text,el){$('#'+ID_MODAL+' .-active').toggleClass('-error',(text.length>0)).find('.message.-danger').toggleClass('_hidden',(!text)).html(text);if(el){el.focus().closest('.field').addClass('danger');}}
function onCheckoutStart_(showLoading){$('#'+ID_MODAL+' .btn-pay').addClass('disabled').prop('disabled',true);if(showLoading){setLoading_('Processing...');}}
function onCheckoutEnd_(xhr,status){if(!(status=='success'&&mode_!=MODE_MANAGE_CARDS_PREMIUM&&mode_!=MODE_MANAGE_CARDS)){$('#'+ID_MODAL+' .btn-pay').removeClass('disabled').prop('disabled',false);}
setLoading_(null);}
function onCardFormSubmit_(){var form=$(this),fields=form.find('.field');setFormError_('');for(var i=0;i<fields.length;i++){$(fields[i]).removeClass('danger');}
var email=$('#checkout-email'),card=$('#checkout-card-number'),expMonth=$('#checkout-card-month'),expYear=$('#checkout-card-year'),securityCode=$('#checkout-security-code');if(email.length){var emailVal=$.trim(email.val());if(!emailVal||!PMW.util.isValidEmail(emailVal)){email.focus().parent().addClass('danger');setFormError_('Please enter a valid email address. We will contact you about your purchase on it.');return false;}}
if(!validateInput_(card,'Please enter a card number.')){return false;}
if(!validateInput_(expMonth,'Please enter the expiry month.')){return false;}
if(!validateInput_(expYear,'Please enter the expiry year.')){return false;}
if(!validateInput_(securityCode,'Please enter the security code. See back of the card.')){return false;}
if(mode_==MODE_STRIPE_PRINT_CHECKOUT){$('#checkout-add-card').find('.btn-continue-checkout').addClass('disabled').prop('disabled',true);}else{onCheckoutStart_(true);}
stripeLoader_.done(function(){Stripe.card.createToken(form,stripeResponseHandler_.bind(this,form));});return false;}
function checkoutWithNewCard_(token){var params=PMW.checkout.getParams(['id','promo','time']),requestParams={st:typeof token!='undefined'?token:0},email=$('#checkout-email');if(email.length){requestParams.email=$.trim(email.val());}
if(mode_===MODE_SUBSCRIPTION){requestParams.spid=params.id;requestParams.promo=params.promo;$.post(PMW.util.site_url('premium/placeOrder'),requestParams).done(stripeCheckoutSuccess_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}
else if(mode_===MODE_DOWNLOAD){requestParams.id=params.id;$.post(PMW.util.site_url('cart/checkoutStripeDownload'),requestParams).done(stripeCheckoutSuccess_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}
else if(mode_===MODE_MANAGE_CARDS_PREMIUM){if(requestParams.email){delete requestParams.email;}
$.post(PMW.util.site_url('premium/createUserCreditCard'),requestParams).done(onCardSetAsDefault_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}
else if(mode_===MODE_MANAGE_CARDS){if(requestParams.email){delete requestParams.email;}
$.post(PMW.util.site_url('premium/createUserCreditCard'),requestParams).done(onCardCreation_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}
else if(mode_==MODE_CHANGE_SUBSCRIPTION_PLAN){requestParams.id=params.id;requestParams.time=params.time;$.post(PMW.util.site_url('premium/changeSubscriptionPlan'),requestParams).done(stripeCheckoutSuccess_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}
else if(mode_==MODE_STRIPE_PRINT_CHECKOUT){$.post(PMW.util.site_url('cart/addCard'),requestParams).done(stripeCheckoutSuccess_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}}
function stripeCheckoutSuccess_(r){if(r.status=='success'){if(mode_==MODE_SUBSCRIPTION){window.location.href=PMW.util.site_url('premium/confirmation');}
else if(mode_==MODE_CHANGE_SUBSCRIPTION_PLAN){window.location.href=PMW.util.site_url('premium/subscriptions');}
else if(mode_==MODE_STRIPE_PRINT_CHECKOUT){var card=r.data.card,cardIcon=r.data.cardIcon;$('#checkout-quick').find('.list').find('.-selected').removeClass('-selected').end().append('<li class="list-item payment-card -selected" data-id="'+card.id+'" data-default="'+(card.default?1:0)+'" data-list-item-type="payment-card"><i class="'+(PMW.isPosterMaker()?'icon-check-thick':'icon-check')+' status"></i><i class="'+cardIcon+' brand" title="'+card.brand+'"></i><span class="digits">Ending in '+card.last4+'</span><div class="delete-options"><i class="icon-delete btn-delete" title="Remove this card"></i><div class="confirm-delete"><i class="icon-check-medium btn-confirm-delete"></i> <i class="icon-close-medium btn-cancel-delete"></i></div></div></li>');$('#checkout-add-card').find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);show_('checkout-quick');}
else{var segmentParams='';if(r.data.idOrder){segmentParams='/'+r.data.idOrder;}
window.location.href=PMW.util.site_url('cart/downloadOrdered'+segmentParams);}
return;}
if(r.status=='fail'){if(r.data&&r.data.email){switch(r.data.email){case'invalid':setFormError_('Please enter a valid email address. We will contact you about your purchase on it.');break;case'exists':setFormError_('An account with this email address already exists. <a href="javascript:void(0)" class="existing-account-info">Click for more information.</a>');PMW.onClick($('#'+ID_MODAL).find('.existing-account-info'),null,PMW.showExistingAccountDialog.bind(this,r.data.emailAddress));break;}}
else{setFormError_('Please enter valid information and try again.');}
return;}
var message='There was an error while processing your request. Please reload the page and try again.';if(r.code){switch(r.code){case'card_error':message=(r.message)?r.message:'Unable to charge your card, please try again or try a different card.';break;case'rate_limit_error':message='The payment service is too busy at the moment. Please wait a few seconds and try again. Your card was not charged.';break;}}
setFormError_(message);}
function stripeCheckoutError_(){setFormError_('There was an error while processing your request. Please reload the page and try again.');}
function stripeResponseHandler_(form,status,response){if(response.error){var label=response.error.type,message='An error occurred while processing the card. It was not charged. Please try again.',el=null;if(response.error.code){label+='-'+response.error.code;}
PMW.trackGAEvent('Cart','StripeError',label);if(response.error.type=='card_error'){switch(response.error.code){case'invalid_number':message='The card number is not a valid credit card number.';el=$('#checkout-card-number');break;case'invalid_expiry_month':message='The card\'s expiration month is invalid.';el=$('#checkout-card-month');break;case'invalid_expiry_year':message='The card\'s expiration year is invalid.';el=$('#checkout-card-year');break;case'invalid_cvc':message='The security code is invalid. Please check and try again.';el=$('#checkout-security-code');break;case'incorrect_number':message='The card number is incorrect. Please check and try again.';el=$('#checkout-card-number');break;case'expired_card':message='The card has expired. Please try a different card.';break;case'incorrect_cvc':message='The card\'s security code is incorrect.';el=$('#checkout-security-code');break;case'card_declined':message='The card was declined. Please try a different card.';break;}}
setFormError_(message,el);if(mode_==MODE_STRIPE_PRINT_CHECKOUT){$('#checkout-add-card').find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);}else{onCheckoutEnd_(null,'error');}}else{checkoutWithNewCard_(response.id);}}
function checkoutWithSelectedCard_(){var params=PMW.checkout.getParams(['id','promo','time']),idCard=$('#'+ID_MODAL+' .payment-card.-selected').attr('data-id');if(!idCard){setFormError_('Please select a card first.');return;}
if(mode_===MODE_SUBSCRIPTION){onCheckoutStart_(true);$.post(PMW.util.site_url('premium/placeOrder'),{st:0,spid:params.id,promo:params.promo,uccid:idCard}).done(stripeCheckoutSuccess_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}
else if(mode_===MODE_DOWNLOAD){onCheckoutStart_(true);$.post(PMW.util.site_url('cart/checkoutStripeDownload'),{id:params.id,uccid:idCard}).done(stripeCheckoutSuccess_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}
else if(mode_===MODE_MANAGE_CARDS_PREMIUM){onCheckoutStart_(true);$.post(PMW.util.site_url('premium/setUserCreditCardAsDefault'),{id:idCard}).done(onCardSetAsDefault_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}else if(mode_===MODE_MANAGE_CARDS){PMW.closeModalDialog(ID_MODAL);}else if(mode_==MODE_CHANGE_SUBSCRIPTION_PLAN){$.post(PMW.util.site_url('premium/changeSubscriptionPlan'),{id:params.id,time:params.time}).done(stripeCheckoutSuccess_).fail(stripeCheckoutError_).always(onCheckoutEnd_);}}
function onCardSetAsDefault_(r){if(r.status=='success'&&r.data&&r.data.brand&&r.data.last4){$('#checkout-card-updated').find('.dialog-message').html('Your <strong>'+r.data.brand+'</strong> card ending in <strong>'+r.data.last4+'</strong> will now be used for subscription payments.');show_('checkout-card-updated');}
else{stripeCheckoutError_();}}
function onCardCreation_(r){if(r.status=='success'&&r.data&&r.data.brand&&r.data.last4){$('#checkout-card-updated').find('.dialog-message').html('Your <strong>'+r.data.brand+'</strong> card ending in <strong>'+r.data.last4+'</strong> has been added in your payment methods.');show_('checkout-card-updated');}
else{stripeCheckoutError_();}}
function onSelectItem_(){var el=$(this);if(el.hasClass('-expandable')&&el.hasClass('-selected')){el.removeClass('-selected').closest('.panel').find('.btn-continue-checkout').addClass('disabled').prop('disabled',true);}else{if(el.hasClass('-expandable')){var list=el.parent(),items=el.parent().children(),height=0;for(var i=0;i<items.length;i++){if(!$(items[i]).hasClass('-selected')){height=$(items[i]).outerHeight(true);break;}}
list.animate({scrollTop:(items.index(el)*height)},250);}
el.addClass('-selected').siblings().removeClass('-selected').end().closest('.panel').find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);}}
function onDeleteItem_(e){e.stopPropagation();var item=$(this).closest('.list-item');switch(item.attr('data-list-item-type')){case'payment-card':onDeleteCard_(item);break;case'address':onDeleteAddress_(item);break;}}
function onDeleteCard_(card){card.addClass('-deleting').removeClass('-selected');setLoading_('Deleting...');$.post(PMW.util.site_url('premium/deleteUserCreditCard'),{id:card.attr('data-id')}).done(deleteCardSuccess_.bind(this,card)).fail(deleteCardError_.bind(this,card,null)).always(function(){setLoading_(null);});}
function deleteCardSuccess_(card,r){if(r.status=='success'){card.addClass('-deleted');setTimeout(onCardDeleted_.bind(this,card,((r.data&&r.data.defaultId)?r.data.defaultId:null)),350);}
else if(r.status=='error'&&r.code&&r.message&&r.message.length>0){deleteCardError_(card,r.message);}
else{deleteCardError_(card,null);}}
function deleteCardError_(card,message){message=!message?'An error occurred while deleting the card. Please try again.':message;card.removeClass('-deleting').find('.-confirm-state').removeClass('-confirm-state');setFormError_(message,null);}
function onCardDeleted_(card,defaultId){card.remove();var modal=$('#'+ID_MODAL),cards=modal.find('.payment-card');if(cards.length==0){show_('checkout-add-card');modal.find('.btn-back-to-cards').addClass('_hidden');setTimeout(function(){getCardForm_().find('.field').first().find('input').focus();},400);}
else if(!cards.is('.-selected')){if(defaultId){cards.filter('[data-id="'+defaultId+'"]').addClass('-selected');}else{cards.first().addClass('-selected');}}}
function getCTAText_(params){if(mode_==MODE_MANAGE_CARDS_PREMIUM){return'Use Selected Card';}
else if(mode_==MODE_MANAGE_CARDS){return'Close';}
else{return'Pay '+((params.price)?params.price:'Now');}}
function getTitle_(){if(mode_==MODE_MANAGE_CARDS_PREMIUM){return'Choose Card for Subscription Payments';}
if(mode_==MODE_MANAGE_CARDS){return'Manage Credit/Debit Cards';}
return'Checkout';}
function initMode_(mode){var amazonBtn;switch(mode){case MODE_PRINT:if(!modePrintInit_){$('#showPayPal').click(function(){$(this).hide();$('#paypalSection').show('slide',{direction:'right',easing:'easeOutQuint'},300);});$('#paypalButton').click(function(){var cartForm=$("#cartForm");cartForm.find('input[name="paymentvendor"]').val('paypal');cartForm.submit();});amazonBtn=$('#amazonButton');window.onAmazonLoginReady=function(){amazon.Login.setClientId(amazonBtn.attr('data-cid'));verifyAmazonUser();};window.onAmazonPaymentsReady=function(){var authRequest;OffAmazonPayments.Button("amazonButton",amazonBtn.attr('data-mid'),{type:"PwA",authorization:function(){var loginOptions={scope:"profile:user_id",popup:"true"};authRequest=amazon.Login.authorize(loginOptions,onAuthorize);},onError:function(error){PMW.log('ERROR returned by OffAmazonPayments.Button during checkout: '+error.getErrorCode()+' '+error.getErrorMessage());}});};PMW.getScript(amazonBtn.attr('data-src'),function(){});function onAuthorize(auth){if(typeof auth.error!='undefined'){switch(auth.error){case'access_denied':break;default:alert('There was an error while contacting Amazon Pay, please try again.');}}else{initPayWithAmazon();}}
modePrintInit_=true;}
break;case MODE_DOWNLOAD:if(!modeDownloadInit_){amazonBtn=$('#amazonButton');$.getScript(amazonBtn.attr('data-src'),function(){OffAmazonPayments.Button("amazonButton",amazonBtn.data('mid'),{type:"hostedPayment",hostedParametersProvider:function(done){$.getJSON(PMW.util.site_url('cart/amazonbuttonparameters'),PMW.checkout.getParams(['id']),function(r){if(r==null||(r!=null&&r.error)){alert('Sorry, there was a problem while communicating with Amazon. Please refresh the page and try again.');return;}
done(r);});},onError:function(error){PMW.log('ERROR returned by OffAmazonPayments.Button during checkout: '+error.getErrorCode()+' '+error.getErrorMessage());}});});$.getScript('https://www.paypalobjects.com/js/external/dg.js',function(){$('#paypalButton').click(function(){var p=PMW.checkout.getParams(['id']),dg=new PAYPAL.apps.DGFlow({expType:'instant'});dg.startFlow(PMW.util.site_url('cart/checkoutPayPalDownload')+'?id='+p.id);});});modeDownloadInit_=true;}
break;}}
function initUI_(panels,modal,params){if(panels.attr('data-need-email')==1){modal.addClass('-need-email');}
else if(panels.attr('data-no-cards')==1){modal.addClass('-no-cards');}
var price=parseFloat(modal.attr('data-param-raw-price')),isPremiumUser=(panels.attr('data-usertype')=='premium');if((mode_==MODE_DOWNLOAD&&(isPremiumUser||price>=STRIPE_PRICE_FLOOR))||mode_==MODE_SUBSCRIPTION||mode_==MODE_MANAGE_CARDS_PREMIUM||mode_==MODE_MANAGE_CARDS||mode_==MODE_CHANGE_SUBSCRIPTION_PLAN){if(panels.attr('data-cards')==0){if(mode_==MODE_DOWNLOAD&&!isPremiumUser){show_('checkout-options');}else{show_('checkout-add-card');}}
else{show_('checkout-quick');}
panels.find('.btn-back-to-cards').addClass('_hidden');panels.find('.btn-pay span').html(getCTAText_(params));if(mode_==MODE_MANAGE_CARDS_PREMIUM){$('#checkout-add-card .btn-pay span').html('Use New Card');}
else if(mode_==MODE_MANAGE_CARDS){$('#checkout-add-card .btn-pay span').html('Add New Card');}else if(mode_==MODE_DOWNLOAD){panels.find('.btn-show-stripe').addClass('_hidden');panels.find('.btn-pay-with-card').removeClass('_hidden').attr('data-show','1');}}else if(mode_==MODE_PRINT){if(panels.attr('data-addresses')>0){idShippingAddress_=initAddressList('checkout-select-shipping-address');idBillingAddress_=initAddressList('checkout-select-billing-address');}
panels.find('.btn-back-to-cards').addClass('_hidden');show_('checkout-options');}else{if(mode_==MODE_DOWNLOAD&&price<STRIPE_PRICE_FLOOR){if(panels.attr('data-cards')==0){panels.find('.btn-back-to-cards').addClass('_hidden');}
panels.find('.btn-show-stripe').removeClass('_hidden');panels.find('.btn-pay-with-card').addClass('_hidden').attr('data-show','0');panels.find('.btn-pay span').html(getCTAText_(params));}
show_('checkout-options');}}
function initAddressList(id){var panel=$('#'+id),list=panel.find('.list'),addresses=list.children(),selected=panel.find('.-selected');if(addresses.length>0){if(selected.length!=0){list.animate({scrollTop:(selected.position().top-list.position().top)},250);}else{selected=addresses.first().addClass('-selected');panel.find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);}
return selected.attr('data-id');}else{PMW.log('checkout-dialog:initAddressList Address list is empty for panel '+id+' for user '+PMW.getUserId());return-1;}}
function initPayWithAmazon(){var amazonWalletWidgetId='amazon-wallet-widget',amazonWalletPanel=$('#checkout-amazon-wallet'),amazonWalletWidget=$('#'+amazonWalletWidgetId);if(amazonWalletPanel.attr('data-amazon-init')=='0'){amazonWalletWidget.on('amazon:paymentSelected',function(){$('#checkout-amazon-wallet').find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);}).on('amazon:sessionExpired',function(){alert('Your Amazon Pay session has expired, please click Checkout to log in again.');logoutAmazon();}).on('amazon:error',function(){alert('Amazon Pay encountered an error. Please click Checkout to try again.');PMW.closeModalDialog(ID_MODAL);});amazonWalletPanel.attr('data-amazon-init','1');setTimeout(function(){amazonWalletPanel.find('.amazon-pay-not-loaded').append('<br><br>This seems to be taking longer than usual. Please reload the page to try again.');},5000);}
var modal=$('#'+ID_MODAL),panels=modal.find('.panels'),orderReferenceId=null;modal.find('.btn-amazon-logout').removeClass('_hidden');new OffAmazonPayments.Widgets.Wallet({sellerId:amazonWalletWidget.attr('data-sid'),onOrderReferenceCreate:function(orderReference){orderReferenceId=orderReference.getAmazonOrderReferenceId();amazonWalletWidget.attr('data-order-ref-id',orderReferenceId);},design:{designMode:'responsive'},onPaymentSelect:function(orderReference){amazonWalletWidget.trigger('amazon:paymentSelected');},onError:function(error){PMW.log('amazonWallet: '+error.getErrorCode()+': '+error.getErrorMessage());switch(error.getErrorCode()){case'BuyerSessionExpired':amazonWalletWidget.trigger('amazon:sessionExpired');break;default:amazonWalletWidget.trigger('amazon:error');}}}).bind(amazonWalletWidgetId);addressMode_='shipping';if(panels.attr('data-addresses')==0){panels.find('.btn-back-to-addresses').addClass('_hidden');show_('checkout-add-address');}else{idShippingAddress_=initAddressList('checkout-select-shipping-address');idBillingAddress_=initAddressList('checkout-select-billing-address');show_('checkout-select-shipping-address');}
mode_=MODE_AMAZON_PRINT_CHECKOUT;}
function verifyAmazonUser(){var previousLoginId=PMW.util.readCookie('pmwpwa'),userId=PMW.getUserId(),needLogout=false;if(previousLoginId==null){needLogout=true;}else{if(previousLoginId!=userId){needLogout=true;}}
if(needLogout){amazon.Login.logout();if(!isNaN(userId)){PMW.util.setCookie('pmwpwa',userId,1);}}}
function validateInput_(el,msg){if($.trim(el.val()).length==0){setFormError_(msg,el);return false;}
return true;}
function onSubmitNewAddress_(){var form=$(this),fields=form.find('.field');removeValidationErrorMessages(fields);var name=$('#checkout-address-name'),address1=$('#checkout-address-line1'),address2=$('#checkout-address-line2'),city=$('#checkout-address-city'),region=(addressMode_=='shipping'?$('#checkout-address-region-states'):$('#checkout-address-region')),postalCode=$('#checkout-address-postal-code'),countryCode=$('#checkout-address-country-code'),phone=$('#checkout-address-phone'),error=false;if(!validateInput_(name,getAddressValidationErrorMessage())){error=true;}
if(!validateInput_(address1,getAddressValidationErrorMessage())){error=true;}
if(!validateInput_(city,getAddressValidationErrorMessage())){error=true;}
if(!validateInput_(region,getAddressValidationErrorMessage())){error=true;}
if(!validateInput_(postalCode,getAddressValidationErrorMessage())){error=true;}
if(!validateInput_(countryCode,getAddressValidationErrorMessage())){error=true;}
if(!validateInput_(phone,getAddressValidationErrorMessage())){error=true;}
if(error){return false;}
$.post(PMW.util.site_url('user/addAddress'),{name:$.trim(name.val()),address1:$.trim(address1.val()),address2:$.trim(address2.val()),city:$.trim(city.val()),region:$.trim(region.val()),postalCode:$.trim(postalCode.val()),countryCode:countryCode.val(),phone:$.trim(phone.val())}).done(onAddAddressSuccess_).fail(onAddAddressFail_);return false;}
function removeValidationErrorMessages(fields){setFormError_('');for(var i=0;i<fields.length;i++){$(fields[i]).removeClass('danger');}}
function onAddAddressSuccess_(r){if(r.status=='success'&&r.data&&r.data.address){var modal=$('#'+ID_MODAL),panel,address=r.data.address,el,list;modal.find('.btn-back-to-addresses').removeClass('_hidden');modal.find('.panels').scrollTop(0);modal.removeClass('-add-address').addClass('-print-checkout');$('#checkout-select-shipping-address, #checkout-select-billing-address').find('.addresses').append('<li class="list-item address -expandable" data-id="'+address.id+'" data-list-item-type="address"><div class="panel-top"><i class="'+(PMW.isPosterMaker()?'icon-check-thick':'icon-check')+' status"></i><div class="address-detail"><span class="contact-name">'+address.contactName+'</span> <span class="address-preview">'+address.streetAddress1+' '+address.streetAddress2+' '+address.city+', '+address.region+' '+address.postalCode+' '+address.countryCode+' '+address.phone+'</span></div><div class="delete-options"><i class="icon-delete btn-delete" title="Remove this address"></i><div class="confirm-delete"><i class="icon-check-medium btn-confirm-delete"></i> <i class="icon-close-medium btn-cancel-delete"></i></div></div><i class="expand-icon"></i></div><div class="panel-content"><div>'+address.streetAddress1+'</div><div>'+address.streetAddress2+'</div><div>'+address.city+', '+address.region+' '+address.postalCode+'</div><div>'+address.countryCode+'</div><div>'+address.phone+'</div></div></li>');if(addressMode_=='shipping'){panel=$('#checkout-select-shipping-address');idShippingAddress_=address.id;el=panel.find('.address[data-id="'+idShippingAddress_+'"]');el.addClass('-selected').siblings().removeClass('-selected');show_('checkout-select-shipping-address');panel.find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);}else{panel=$('#checkout-select-billing-address');idBillingAddress_=address.id;el=panel.find('.address[data-id="'+idBillingAddress_+'"]');el.addClass('-selected').siblings().removeClass('-selected');show_('checkout-select-billing-address');panel.find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);}
list=panel.find('.list');list.animate({scrollTop:(el.position().top-list.position().top+list.scrollTop())},250);}else if(r.status=='fail'){setFormError_(getAddressValidationErrorMessage());}}
function onAddAddressFail_(){alert('Sorry, there was an error. Please try again. If this error persists please reload the page and try again.');}
function getAddressValidationErrorMessage(){return"All fields besides Address Line 2 are required";}
function onDeleteAddress_(address){address.addClass('-deleting');setLoading_('Deleting...');$.post(PMW.util.site_url('user/deleteAddress'),{id:address.attr('data-id')}).done(deleteAddressSuccess_.bind(this,address)).fail(deleteAddressError_.bind(this,address,null)).always(function(){setLoading_(null);});}
function deleteAddressSuccess_(address,r){if(r.status=='success'){address.addClass('-deleted');setTimeout(onAddressDeleted_.bind(this,address),350);var shippingPanel=$('#checkout-select-shipping-address'),billingPanel=$('#checkout-select-billing-address');if(shippingPanel.find('.address[data-id='+address.attr('data-id')+']').hasClass('-selected')){shippingPanel.find('.btn-continue-checkout').addClass('disabled').prop('disabled',true);}
if(billingPanel.find('.address[data-id='+address.attr('data-id')+']').hasClass('-selected')){billingPanel.find('.btn-continue-checkout').addClass('disabled').prop('disabled',true);}}
else if(r.status=='error'&&r.code&&r.message&&r.message.length>0){deleteAddressError_(address,r.message);}
else{deleteAddressError_(address,null);}}
function deleteAddressError_(address,message){message=!message?'An error occurred while deleting the address. Please try again.':message;address.removeClass('-deleting').find('.-confirm-state').removeClass('-confirm-state');setFormError_(message,null);}
function onAddressDeleted_(address){$('#checkout-select-shipping-address').find('.address[data-id='+address.attr('data-id')+']').remove();$('#checkout-select-billing-address').find('.address[data-id='+address.attr('data-id')+']').remove();var modal=$('#'+ID_MODAL),addresses=modal.find('.address');if(addresses.length==0){show_('checkout-add-address');modal.find('.btn-back-to-addresses').addClass('_hidden');setTimeout(function(){getAddressForm_().find('.field').first().find('input').focus();},400);}
else if(!addresses.is('.-selected')){addresses.first().addClass('-selected');}}
function getShippingCost_(btn){var shippingMethods=$('#checkout-select-shipping-method').find('.shipping-methods');if(shippingMethods.find('li').length==0){$.getJSON(PMW.util.site_url('cart/getShippingCost')).done(getShippingCostSuccess_.bind(this,shippingMethods)).always(function(){btn.removeClass('disabled').prop('disabled',false);});}else{show_('checkout-select-shipping-method',FLOW_FORWARD);}}
function getShippingCostSuccess_(shippingMethods,r){if(r.status=='success'&&r.data){for(var i=0;i<r.data.shippingOptions.length;i++){shippingMethods.append('<li class="list-item shipping-method'+((i==0)?' -selected':'')+'" data-id="'+r.data.shippingOptions[i].id+'"><i class="'+(PMW.isPosterMaker()?'icon-check-thick':'icon-check')+' status"></i><div class="shipping-method-detail"><div class="name">'+r.data.shippingOptions[i].name+'</div><div class="cost">'+r.data.shippingOptions[i].cost+'</div></div></li>');}
$('#checkout-select-shipping-method').find('.btn-continue-checkout').removeClass('disabled').prop('disabled',false);show_('checkout-select-shipping-method',FLOW_FORWARD);}else{alert('Sorry, there was an error. Please reload the page and try again.');}}
function getCheckoutSummary_(btn){$.getJSON(PMW.util.site_url('cart/getCheckoutSummary'),{shipping:idShippingAddress_,billing:idBillingAddress_,shippingMethod:idShippingMethod_}).done(onGetCheckoutSummarySuccess_).always(function(){btn.removeClass('disabled').prop('disabled',false);})}
function onGetCheckoutSummarySuccess_(r){if(r.status=='success'){var amazonReview=$('#checkout-print-review'),address=r.data.shippingAddress;amazonReview.find('.review-shipping-address').html('<div class="address-detail"><span class="address-line contact-name">'+address.contactName+'</span> <span class="address-line address1">'+address.streetAddress1+'</span> <span class="address-line address2">'+address.streetAddress2+'</span> <span class="address-line">'+address.city+', '+address.region+' '+address.postalCode+'</span> <span class="address-line">'+address.countryCode+'</span> <span class="address-line">'+address.phone+'</span> </div>');amazonReview.find('.review-shipping-method').html('<div class="shipping-method">'+r.data.shippingMethod+'</div>');amazonReview.find('.item-total > .amount').html(r.data.itemTotal);amazonReview.find('.shipping-total > .amount').html(r.data.shippingTotal);amazonReview.find('.tax-total > .amount').html(r.data.taxTotal);amazonReview.find('.grand-total > .amount').html(r.data.grandTotal);amazonReview.find('.btn-pay').html('<i class="icon-https left"></i> Pay '+r.data.grandTotal);show_('checkout-print-review',FLOW_FORWARD);}else if(r.status=='error'&&r.code){switch(r.code){case'billing_address_not_found':alert('Billing address was not selected. Please select a billing address.');addressMode_='billing';show_('checkout-select-billing-address',FLOW_BACKWARD);break;case'shipping_address_not_found':alert('Shipping address was not selected. Please select a shipping address.');addressMode_='shipping';show_('checkout-select-shipping-address',FLOW_BACKWARD);break;case'shipping_method_not_found':alert('Shipping speed was not selected. Please select a shipping speed.');show_('checkout-select-shipping-method',FLOW_BACKWARD);break;case'cannot_ship_to_address':alert('We currently only ship within the US. Please select a US based shipping address');show_('checkout-select-shipping-address',FLOW_BACKWARD);break;case'missing_params':break;}}}
function logoutAmazon(){amazon.Login.logout();$('#'+ID_MODAL).find('.btn-amazon-logout').addClass('_hidden');PMW.closeModalDialog(ID_MODAL);}
function onCheckoutSuccess(r){if(r.status=='success'){var vendor='';if(mode_==MODE_AMAZON_PRINT_CHECKOUT){vendor='a';}else if(mode_==MODE_STRIPE_PRINT_CHECKOUT){vendor='s';}
window.location.href=PMW.util.site_url('cart/printCheckoutComplete?v='+vendor);}else if(r.status=='error'&&r.code&&r.code=='cannot_ship_to_address'){alert('We currently only ship Prints within the US.');}else{alert('We encountered an error while processing your order. Please try again.');PMW.closeModalDialog(ID_MODAL);}}
function onCheckoutFail(){alert('Sorry, there was an error. Please reload the page and try again.');}
return{MODE_PRINT:'print',MODE_DOWNLOAD:'download',MODE_SUBSCRIPTION:'subscription',MODE_MANAGE_CARDS_PREMIUM:'manage-premium',MODE_MANAGE_CARDS:'manage',MODE_CHANGE_SUBSCRIPTION_PLAN:'change-subscription-plan',MODE_AMAZON_PRINT_CHECKOUT:'amazon-print-checkout',showCheckoutDialog:function(mode,params,facade){if(PMW.isStudent()){alert("Sorry, students cannot make purchases.");return;}
mode_=mode;facade_=facade?facade:null;var modal=PMW.openModalDialog(ID_MODAL,getTitle_(),null,(mode==MODE_MANAGE_CARDS_PREMIUM||mode==MODE_MANAGE_CARDS),'-flex'),c=modal.find('.content'),panels=c.find('.panels');if(params){for(var prop in params){if(params.hasOwnProperty(prop)){modal.attr('data-param-'+prop,params[prop]);}}}
else{params={};}
if(panels.length===0){modal.on('modal:close',this.onModalClose.bind(this,modal));c.load(PMW.util.site_url('cart/checkoutDialog'),{mode:mode,isPosterMaker:PMW.isPosterMaker()?1:0},function(response,status,xhr){if(status=="error"){alert('Sorry, there was an error. Please reload the page and try again.');PMW.log('Error loading checkout dialog.'+xhr.status+' '+xhr.statusText);c.empty().append('<h2 class="please-wait">Please Wait&hellip;</h2>');PMW.closeModalDialog(ID_MODAL);return;}
panels=$(this).find('.panels');getCardForm_().submit(onCardFormSubmit_);PMW.onClick(modal.find('.btn-pay'),null,function(){var panelId=panels.find('>.-active').attr('id');switch(panelId){case'checkout-add-card':getCardForm_().submit();break;case'checkout-quick':checkoutWithSelectedCard_();break;case'checkout-print-review':onCheckoutStart_(true);var params={'shipping':idShippingAddress_,'billing':idBillingAddress_,'shippingMethod':idShippingMethod_};if(mode_==MODE_AMAZON_PRINT_CHECKOUT){params['orderRefId']=$('#amazon-wallet-widget').attr('data-order-ref-id');params['paymentvendor']='amazon';}else if(mode_==MODE_STRIPE_PRINT_CHECKOUT){params['uccid']=$('#'+ID_MODAL+' .payment-card.-selected').attr('data-id');params['paymentvendor']='stripe';}else{throw"Unknown mode: "+mode+" from review panel";}
$.post('cart/updateandcheckout',params).done(onCheckoutSuccess).fail(onCheckoutFail).always(onCheckoutEnd_);break;default:throw"Pay button called from unknown checkout panel: "+panelId;}});getAddressForm_().submit(onSubmitNewAddress_);PMW.onClick(modal.find('.btn-continue-checkout'),null,function(){var panel=panels.find('>.-active'),panelId=panel.attr('id'),btn;switch(panelId){case'checkout-add-address':getAddressForm_().submit();break;case'checkout-select-shipping-address':idShippingAddress_=panel.find('.address.-selected').attr('data-id');addressMode_='billing';show_('checkout-select-billing-address',FLOW_FORWARD);break;case'checkout-select-billing-address':idBillingAddress_=panel.find('.address.-selected').attr('data-id');switch(mode_){case MODE_AMAZON_PRINT_CHECKOUT:show_('checkout-amazon-wallet',FLOW_FORWARD);break;case MODE_STRIPE_PRINT_CHECKOUT:if($('#checkout-quick').find('.list-item').length==0){show_('checkout-add-card',FLOW_FORWARD);}
else{show_('checkout-quick',FLOW_FORWARD);}
break;default:throw"Continue button on checkout-select-billing-address panel called with unknown mode: "+mode_;}
break;case'checkout-add-card':if(mode_==MODE_STRIPE_PRINT_CHECKOUT){getCardForm_().submit();}
break;case'checkout-amazon-wallet':case'checkout-quick':btn=panel.find('.btn-continue-checkout');btn.addClass('disabled').prop('disabled',true);getShippingCost_(btn);break;case'checkout-select-shipping-method':idShippingMethod_=panel.find('.shipping-method.-selected').attr('data-id');btn=panel.find('.btn-continue-checkout');btn.addClass('disabled').prop('disabled',true);getCheckoutSummary_(btn);break;default:throw"Continue button called from unknown checkout panel: "+panelId;}});PMW.onClick(modal.find('.btn-close'),null,PMW.closeModalDialog.bind(this,ID_MODAL));PMW.onClick(modal.find('.btn-add-card'),null,function(){modal.find('.btn-back-to-cards').removeClass('_hidden');show_('checkout-add-card');});PMW.onClick(modal.find('.btn-back-to-cards'),null,function(){show_('checkout-quick',FLOW_BACKWARD);});PMW.onClick(modal,'.list-item',onSelectItem_);PMW.onClick(modal,'.list-item .btn-delete',function(e){e.stopPropagation();$(this).closest('.delete-options').addClass('-confirm-state').siblings('.address-detail').addClass('-delete-mode');});PMW.onClick(modal,'.list-item .btn-confirm-delete',onDeleteItem_);PMW.onClick(modal,'.list-item .btn-cancel-delete',function(e){e.stopPropagation();$(this).closest('.delete-options').removeClass('-confirm-state').siblings('.address-detail').removeClass('-delete-mode');});PMW.onClick(modal.find('.btn-add-address'),null,function(){show_('checkout-add-address');});PMW.onClick(modal.find('.btn-back-to-addresses'),null,function(){modal.removeClass('-add-address').addClass('-print-checkout');if(addressMode_=='shipping'){show_('checkout-select-shipping-address');}else{show_('checkout-select-billing-address');}});PMW.onClick(modal.find('.btn-back-to-shipping'),null,function(){addressMode_='shipping';show_('checkout-select-shipping-address',FLOW_BACKWARD);});PMW.onClick(modal.find('.btn-back-to-billing'),null,function(){addressMode_='billing';show_('checkout-select-billing-address',FLOW_BACKWARD);});PMW.onClick(modal.find('.btn-back-to-wallet'),null,function(){if(mode_==MODE_AMAZON_PRINT_CHECKOUT){show_('checkout-amazon-wallet',FLOW_BACKWARD);}else if(mode_==MODE_STRIPE_PRINT_CHECKOUT){if(modal.find('.payment-card').length==0){show_('checkout-add-card',FLOW_BACKWARD);}
else{show_('checkout-quick',FLOW_BACKWARD);}}});PMW.onClick(modal.find('.btn-back-to-shipping-method'),null,function(){modal.removeClass('-print-checkout-review');show_('checkout-select-shipping-method',FLOW_BACKWARD);});PMW.onClick(modal.find('.btn-pay-with-card'),null,function(){if(mode==MODE_PRINT){mode_=MODE_STRIPE_PRINT_CHECKOUT;if(panels.attr('data-addresses')>0){show_('checkout-select-shipping-address');}else{show_('checkout-add-address');}}else{if(modal.find('.payment-card').length==0){show_('checkout-add-card');}
else{show_('checkout-quick');}}});PMW.onClick(modal.find('.btn-show-stripe'),null,function(){$(this).addClass('_hidden');if(panels.attr('data-cards')==0){show_('checkout-add-card');}
else{show_('checkout-quick');}
modal.find('.btn-pay-with-card').removeClass('_hidden').attr('data-show','1');});if(window.initResponsiveToolTips){initResponsiveToolTips();}
if(mode==MODE_DOWNLOAD){PMW.addModalHeaderButtons(modal,{'Payment Methods':{cb:show_.bind(this,'checkout-options'),classes:'btn-payment-options'}});}else if(mode==MODE_PRINT){PMW.addModalHeaderButtons(modal,{'Logout Amazon':{cb:logoutAmazon,classes:'btn-amazon-logout _hidden'}});}
initUI_(panels,modal,params);initMode_(mode);});}
else{initUI_(panels,modal,params);initMode_(mode);}},onModalClose:function(m){if(mode_==MODE_STRIPE_PRINT_CHECKOUT||mode_==MODE_AMAZON_PRINT_CHECKOUT){history.replaceState('','','cart');m.removeClass('-print-checkout -add-address -print-checkout-review');m.find('.panels').scrollTop(0);$('#checkout-select-shipping-method').find('.shipping-methods').empty();}},getParams:function(params){var modal=$('#'+ID_MODAL),p={};for(var i=0;i<params.length;i++){p[params[i]]=modal.attr('data-param-'+params[i]);}
return p;}};})();
